name: Release (Pages + Tauri)

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      tag:
        description: "Existing tag to release (e.g. v0.1.0)"
        required: true
        type: string
      prerelease:
        description: "Mark the GitHub Release as a prerelease"
        required: false
        default: false
        type: boolean

permissions:
  contents: write
  pages: write
  id-token: write

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: false

jobs:
  meta:
    name: Resolve Release Metadata
    runs-on: ubuntu-latest
    outputs:
      release_tag: ${{ steps.out.outputs.release_tag }}
      prerelease: ${{ steps.out.outputs.prerelease }}
    steps:
      - name: Tag (push)
        if: github.event_name == 'push'
        run: |
          echo "RELEASE_TAG=${GITHUB_REF_NAME}" >> "$GITHUB_ENV"
          echo "PRERELEASE=false" >> "$GITHUB_ENV"

      - name: Tag (workflow_dispatch)
        if: github.event_name == 'workflow_dispatch'
        run: |
          echo "RELEASE_TAG=${{ inputs.tag }}" >> "$GITHUB_ENV"
          echo "PRERELEASE=${{ inputs.prerelease }}" >> "$GITHUB_ENV"

      - id: out
        run: |
          echo "release_tag=${RELEASE_TAG}" >> "$GITHUB_OUTPUT"
          echo "prerelease=${PRERELEASE}" >> "$GITHUB_OUTPUT"

  ensure_tag:
    name: Ensure Tag Exists
    runs-on: ubuntu-latest
    needs: meta
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 1
          # Always build/release the commit that triggered the workflow.
          ref: ${{ github.sha }}

      - name: Create and push tag if missing
        shell: bash
        env:
          RELEASE_TAG: ${{ needs.meta.outputs.release_tag }}
        run: |
          set -euo pipefail
          if git ls-remote --exit-code --tags origin "refs/tags/${RELEASE_TAG}" >/dev/null 2>&1; then
            echo "Tag ${RELEASE_TAG} exists on origin."
            exit 0
          fi

          echo "Tag ${RELEASE_TAG} missing on origin; creating at ${GITHUB_SHA}."
          git tag "${RELEASE_TAG}" "${GITHUB_SHA}"
          git push origin "refs/tags/${RELEASE_TAG}"

  pages_build:
    name: Build Web (Pages)
    runs-on: ubuntu-latest
    needs: [meta, ensure_tag]
    concurrency:
      group: pages
      cancel-in-progress: true
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 1
          ref: ${{ github.sha }}

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install
        run: npm ci

      - name: Build web
        env:
          VITE_BASE_PATH: "/${{ github.event.repository.name }}/"
        run: npm run build -w @moltpostor/web

      - uses: actions/configure-pages@v5

      - uses: actions/upload-pages-artifact@v3
        with:
          path: apps/web/dist

  pages_deploy:
    name: Deploy Web (Pages)
    runs-on: ubuntu-latest
    needs: pages_build
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - id: deployment
        uses: actions/deploy-pages@v4

  desktop:
    name: Desktop Bundles (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    needs: pages_build
    env:
      RELEASE_TAG: ${{ needs.meta.outputs.release_tag }}
    strategy:
      fail-fast: false
      matrix:
        os: [windows-latest, macos-latest, ubuntu-latest]
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 1
          ref: ${{ github.sha }}

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - uses: dtolnay/rust-toolchain@stable

      - name: Install Linux dependencies
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libgtk-3-dev \
            libwebkit2gtk-4.1-dev \
            libayatana-appindicator3-dev \
            librsvg2-dev \
            patchelf

      - name: Install JS deps
        run: npm ci

      - name: Build desktop bundles
        run: npm run build -w @moltpostor/desktop

      - name: Upload Windows bundles
        if: matrix.os == 'windows-latest'
        uses: actions/upload-artifact@v4
        with:
          name: desktop-windows
          if-no-files-found: error
          path: |
            apps/desktop/src-tauri/target/release/bundle/nsis/*.exe
            apps/desktop/src-tauri/target/release/bundle/msi/*.msi

      - name: Upload macOS bundles
        if: matrix.os == 'macos-latest'
        uses: actions/upload-artifact@v4
        with:
          name: desktop-macos
          if-no-files-found: error
          path: |
            apps/desktop/src-tauri/target/release/bundle/dmg/*.dmg
            apps/desktop/src-tauri/target/release/bundle/macos/*.app.tar.gz

      - name: Upload Linux bundles
        if: matrix.os == 'ubuntu-latest'
        uses: actions/upload-artifact@v4
        with:
          name: desktop-linux
          if-no-files-found: error
          path: |
            apps/desktop/src-tauri/target/release/bundle/appimage/*.AppImage
            apps/desktop/src-tauri/target/release/bundle/deb/*.deb
            apps/desktop/src-tauri/target/release/bundle/rpm/*.rpm

  android:
    name: Android (APK/AAB)
    runs-on: ubuntu-latest
    needs: pages_build
    env:
      RELEASE_TAG: ${{ needs.meta.outputs.release_tag }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 1
          ref: ${{ github.sha }}

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - uses: dtolnay/rust-toolchain@stable

      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - uses: android-actions/setup-android@v3

      - name: Install Android NDK
        run: |
          yes | sdkmanager --licenses
          sdkmanager "ndk;26.3.11579264"

      - name: Install JS deps
        run: npm ci

      - name: Require Android signing secrets
        shell: bash
        env:
          ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
          ANDROID_KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          ANDROID_KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
          ANDROID_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
        run: |
          missing=0
          for k in ANDROID_KEYSTORE_BASE64 ANDROID_KEYSTORE_PASSWORD ANDROID_KEY_ALIAS ANDROID_KEY_PASSWORD; do
            if [ -z "${!k}" ]; then
              echo "::error::Missing required secret: $k"
              missing=1
            fi
          done
          if [ "$missing" -ne 0 ]; then
            exit 1
          fi

      - name: Decode keystore
        shell: bash
        run: |
          mkdir -p apps/desktop/src-tauri/gen/android/app
          echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 --decode > apps/desktop/src-tauri/gen/android/app/upload-keystore.jks
          cat > apps/desktop/src-tauri/gen/android/app/key.properties <<'EOF'
          storeFile=upload-keystore.jks
          storePassword=${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          keyAlias=${{ secrets.ANDROID_KEY_ALIAS }}
          keyPassword=${{ secrets.ANDROID_KEY_PASSWORD }}
          EOF

      - name: Build Android (release)
        run: npm run android:build -w @moltpostor/desktop

      - name: Upload Android outputs
        uses: actions/upload-artifact@v4
        with:
          name: android
          if-no-files-found: error
          path: |
            apps/desktop/src-tauri/gen/android/app/build/outputs/**/*.apk
            apps/desktop/src-tauri/gen/android/app/build/outputs/**/*.aab

  release:
    name: GitHub Release
    runs-on: ubuntu-latest
    needs: [meta, ensure_tag, pages_deploy, desktop, android]
    steps:
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          path: release-assets
          merge-multiple: true

      - name: Create GitHub Release and upload assets
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.meta.outputs.release_tag }}
          name: Moltpostor ${{ needs.meta.outputs.release_tag }}
          prerelease: ${{ needs.meta.outputs.prerelease == 'true' }}
          generate_release_notes: true
          files: |
            release-assets/**
