name: Release (Pages + Tauri)

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      tag:
        description: "Existing tag to release (e.g. v0.1.0)"
        required: true
        type: string
      prerelease:
        description: "Mark the GitHub Release as a prerelease"
        required: false
        default: false
        type: boolean

permissions:
  contents: write
  pages: write
  id-token: write

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: false

jobs:
  meta:
    name: Resolve Release Metadata
    runs-on: ubuntu-latest
    outputs:
      release_tag: ${{ steps.out.outputs.release_tag }}
      prerelease: ${{ steps.out.outputs.prerelease }}
    steps:
      - name: Tag (push)
        if: github.event_name == 'push'
        run: |
          echo "RELEASE_TAG=${GITHUB_REF_NAME}" >> "$GITHUB_ENV"
          echo "PRERELEASE=false" >> "$GITHUB_ENV"

      - name: Tag (workflow_dispatch)
        if: github.event_name == 'workflow_dispatch'
        run: |
          echo "RELEASE_TAG=${{ inputs.tag }}" >> "$GITHUB_ENV"
          echo "PRERELEASE=${{ inputs.prerelease }}" >> "$GITHUB_ENV"

      - id: out
        run: |
          echo "release_tag=${RELEASE_TAG}" >> "$GITHUB_OUTPUT"
          echo "prerelease=${PRERELEASE}" >> "$GITHUB_OUTPUT"

  pages_build:
    name: Build Web (Pages)
    runs-on: ubuntu-latest
    needs: meta
    concurrency:
      group: pages
      cancel-in-progress: true
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install
        run: npm ci

      - name: Build web
        env:
          VITE_BASE_PATH: "/${{ github.event.repository.name }}/"
        run: npm run build -w @moltpostor/web

      - uses: actions/configure-pages@v5

      - uses: actions/upload-pages-artifact@v3
        with:
          path: apps/web/dist

  pages_deploy:
    name: Deploy Web (Pages)
    runs-on: ubuntu-latest
    needs: pages_build
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - id: deployment
        uses: actions/deploy-pages@v4

  desktop:
    name: Desktop Bundles (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    needs: pages_build
    env:
      RELEASE_TAG: ${{ needs.meta.outputs.release_tag }}
    strategy:
      fail-fast: false
      matrix:
        os: [windows-latest, macos-latest, ubuntu-latest]
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - uses: dtolnay/rust-toolchain@stable

      - name: Install Linux dependencies
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libgtk-3-dev \
            libwebkit2gtk-4.1-dev \
            libayatana-appindicator3-dev \
            librsvg2-dev \
            patchelf

      - name: Install JS deps
        run: npm ci

      - name: Build desktop bundles
        run: npm run build -w @moltpostor/desktop

      - name: Archive bundles (Windows)
        if: matrix.os == 'windows-latest'
        shell: pwsh
        run: |
          $zip = Join-Path $env:GITHUB_WORKSPACE "moltpostor-${{ env.RELEASE_TAG }}-${{ matrix.os }}.zip"
          Compress-Archive -Path "apps/desktop/src-tauri/target/release/bundle/*" -DestinationPath $zip -Force
          echo "BUNDLE_ZIP=$zip" >> $env:GITHUB_ENV

      - name: Archive bundles (macOS/Linux)
        if: matrix.os != 'windows-latest'
        shell: bash
        run: |
          zip="$GITHUB_WORKSPACE/moltpostor-${RELEASE_TAG}-${{ matrix.os }}.zip"
          zip -r "$zip" apps/desktop/src-tauri/target/release/bundle
          echo "BUNDLE_ZIP=$zip" >> "$GITHUB_ENV"

      - name: Upload desktop bundle archive
        uses: actions/upload-artifact@v4
        with:
          name: desktop-${{ matrix.os }}
          path: ${{ env.BUNDLE_ZIP }}

  android:
    name: Android (APK/AAB)
    runs-on: ubuntu-latest
    needs: pages_build
    env:
      RELEASE_TAG: ${{ needs.meta.outputs.release_tag }}
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - uses: dtolnay/rust-toolchain@stable

      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - uses: android-actions/setup-android@v3

      - name: Install Android NDK
        run: |
          yes | sdkmanager --licenses
          sdkmanager "ndk;26.3.11579264"

      - name: Install JS deps
        run: npm ci

      - name: Build Android (release)
        run: npm run android:build -w @moltpostor/desktop

      - name: Archive Android outputs
        shell: bash
        run: |
          zip="$GITHUB_WORKSPACE/moltpostor-${RELEASE_TAG}-android.zip"
          zip -r "$zip" apps/desktop/src-tauri/gen/android/app/build/outputs
          echo "ANDROID_ZIP=$zip" >> "$GITHUB_ENV"

      - name: Upload Android archive
        uses: actions/upload-artifact@v4
        with:
          name: android
          path: ${{ env.ANDROID_ZIP }}

  release:
    name: GitHub Release
    runs-on: ubuntu-latest
    needs: [meta, pages_deploy, desktop, android]
    steps:
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          path: release-assets
          merge-multiple: true

      - name: Create GitHub Release and upload assets
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.meta.outputs.release_tag }}
          target_commitish: ${{ github.sha }}
          name: Moltpostor ${{ needs.meta.outputs.release_tag }}
          prerelease: ${{ needs.meta.outputs.prerelease == 'true' }}
          generate_release_notes: true
          files: |
            release-assets/**
